{"_id": "e275dfd4409042ec", "name": "DBAE – Cast Spell (WP + Roll)", "type": "script", "img": "icons/svg/dice-target.svg", "command": "// Dragonbane Arcane Expansion: Cast Spell helper\n// Select a token, then run. It will prompt for one of the actor's spell items.\n// It will: (1) deduct WP if it can find a WP field, (2) roll damage/heal if the spell has a formula,\n// (3) post a chat card. If HP/WP paths differ in your Dragonbane system version, it will warn you.\n\nfunction getFirstPath(obj, paths) {\n  for (const p of paths) {\n    const parts = p.split(\".\");\n    let cur = obj;\n    let ok = true;\n    for (const part of parts) {\n      if (cur && Object.prototype.hasOwnProperty.call(cur, part)) cur = cur[part];\n      else { ok = false; break; }\n    }\n    if (ok) return p;\n  }\n  return null;\n}\n\nfunction getAtPath(obj, path) {\n  const parts = path.split(\".\");\n  return parts.reduce((o,k)=> (o? o[k]: undefined), obj);\n}\n\nasync function setAtPath(doc, path, value) {\n  const update = {};\n  update[path] = value;\n  return doc.update(update);\n}\n\nconst token = canvas?.tokens?.controlled?.[0];\nif (!token) return ui.notifications.warn(\"Select a token first.\");\nconst actor = token.actor;\nif (!actor) return ui.notifications.warn(\"No actor found on selected token.\");\n\nconst spells = actor.items.filter(i => i.type === \"spell\" || i.getFlag(\"dragonbane-arcane-expansion\",\"wp_cost\") !== undefined);\nif (!spells.length) return ui.notifications.warn(\"No spell items found on this actor.\");\n\nconst options = spells.map(s => `<option value=\"${s.id}\">${s.name}</option>`).join(\"\");\nconst dlg = await new Promise(resolve => {\n  new Dialog({\n    title: \"Cast Spell\",\n    content: `<form><div class=\"form-group\"><label>Spell</label><select id=\"spell\">${options}</select></div></form>`,\n    buttons: {\n      cast: { label: \"Cast\", callback: html => resolve(html.find(\"#spell\").val()) },\n      cancel: { label: \"Cancel\", callback: () => resolve(null) }\n    },\n    default: \"cast\"\n  }).render(true);\n});\nif (!dlg) return;\n\nconst item = actor.items.get(dlg);\nconst flags = item.getFlag(\"dragonbane-arcane-expansion\",\"\") || {};\nconst wpCost = Number(flags.wp_cost ?? flags.wp ?? 0) || 0;\nconst rollInfo = flags.roll ?? null;\n\n// Try to find WP field\nconst wpPath = getFirstPath(actor.system, [\n  \"willPoints.value\",\"willPoints.base\",\"willPoints.max\",\"wp.value\",\"wp.current\",\"willpower.value\",\"willpower.current\",\"resources.wp.value\",\"resources.wp.current\"\n]);\n\nlet wpBefore = null, wpAfter = null, wpOk = false;\nif (wpPath) {\n  wpBefore = getAtPath(actor.system, wpPath);\n  if (typeof wpBefore === \"number\") {\n    wpAfter = Math.max(0, wpBefore - wpCost);\n    await setAtPath(actor, \"system.\"+wpPath, wpAfter);\n    wpOk = true;\n  }\n}\n\nlet rollResult = null;\nif (rollInfo?.formula) {\n  const r = await (new Roll(rollInfo.formula)).roll({async:true});\n  rollResult = r;\n}\n\nconst school = item.system?.school ?? flags.school ?? \"\";\nconst tier = flags.tier ?? \"\";\nconst dtype = rollInfo?.damageType ?? \"\";\nconst rtype = rollInfo?.type ?? \"\";\n\nlet msg = `<h2>${item.name}</h2>`;\nmsg += `<p><strong>School:</strong> ${school || \"—\"} ${tier? `&nbsp; <strong>Tier:</strong> ${tier}`:\"\"}</p>`;\nmsg += `<p><strong>WP Cost:</strong> ${wpCost} ${wpOk? `(WP: ${wpBefore} → ${wpAfter})`:\"(WP not auto-deducted; check actor sheet WP field)\"}</p>`;\n\nif (rollResult) {\n  msg += `<p><strong>${rtype === \"healing\" ? \"Healing\" : \"Damage\"} Roll:</strong> ${rollInfo.formula} ${dtype? `(${dtype})`:\"\"}</p>`;\n  msg += await rollResult.render();\n}\n\nmsg += `<hr/>${item.system?.description?.value ?? \"\"}`;\n\nChatMessage.create({\n  speaker: ChatMessage.getSpeaker({actor}),\n  content: msg\n});", "ownership": {"default": 0}}
